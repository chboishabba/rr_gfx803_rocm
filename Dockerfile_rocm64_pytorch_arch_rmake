# Docker Buildfile for ROCm 6.4 to recompile PyTorch/Torchvision/Torchaudio
# Arch Linux base image (rocm6_gfx803_base_arch:rmake)
# created, build and compiled by Robert Rosenbusch at April 2025

### Build rocm6_gfx803_base_arch:rmake first! Read the README.md, it could save lifetime :P
FROM rocm6_gfx803_base_arch:rmake

SHELL ["/bin/bash", "-c"]
ENV WHISPERX_GUI_PORT=7860 \
    DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTHONENCODING==UTF-8 \
    REQS_FILE='requirements.txt' \
    COMMANDLINE_ARGS='' \
    PIP_ROOT_USER_ACTION='ignore' \
    ### For your AMD GPU
    PYTORCH_ROCM_ARCH=gfx803

###########
### Python 3.13 (cache-friendly: keep before cloning PyTorch)
###########
RUN echo "** SETUP PYTHON 3.13 *** " && \
    if ! command -v python3.13 >/dev/null 2>&1; then \
        sudo -u builder paru -S --noconfirm --needed python313; \
    fi && \
    python3.13 --version && \
    python3.13 -m ensurepip --upgrade && \
    python3.13 -m venv /opt/py313 && \
    /opt/py313/bin/python -m pip install --upgrade pip setuptools wheel && \
    true

###########
### Build PyTorch
###########
WORKDIR /
ENV PYTORCH_GIT_VERSION="release/2.6"
RUN echo "** Checkout PyTorch: ${PYTORCH_GIT_VERSION} **" && \
    git clone --recursive https://github.com/ROCm/pytorch.git -b ${PYTORCH_GIT_VERSION} /pytorch && \
    true

# Fix gloo types header missing cstdint include (breaks with some toolchains)
RUN sed -i '30i\\#include <cstdint>' /pytorch/third_party/gloo/gloo/types.h

WORKDIR /pytorch

# Make bundled protobuf compatible with CMake >= 4 (after Python layer to preserve cache)
RUN sed -i 's/cmake_minimum_required(VERSION 3.0)/cmake_minimum_required(VERSION 3.5)/' \
    /pytorch/third_party/protobuf/cmake/CMakeLists.txt

RUN echo "** PYTORCH DEPS *** " && \
    sudo -u builder paru -S --noconfirm --needed protobuf && \
    mkdir -p /pytorch/dist && \
    /opt/py313/bin/python setup.py clean && \
    /opt/py313/bin/pip install -r ${REQS_FILE} && \
    true

RUN echo "** PYTORCH BUILD AMD *** " && \
    export USE_FBGEMM=1 USE_TENSORPIPE=0 USE_SYSTEM_PROTOBUF=1 BUILD_CUSTOM_PROTOBUF=OFF CXXFLAGS="-Wno-error=maybe-uninitialized" && \
    /opt/py313/bin/python tools/amd_build/build_amd.py && \
    true

RUN echo "** PYTORCH WHEEL *** " && \
    export USE_SYSTEM_PROTOBUF=1 BUILD_CUSTOM_PROTOBUF=OFF && \
    /opt/py313/bin/python setup.py bdist_wheel && \
    true

RUN echo "** PYTORCH INSTALL *** " && \
    /opt/py313/bin/pip install dist/torch*.whl && \
    true

###########
### Build TorchVision
###########
ENV TORCH_GIT_VERSION="release/0.21"
RUN echo "** Checkout Torchvision Version: ${TORCH_GIT_VERSION} ** " && \
   git clone https://github.com/pytorch/vision.git -b ${TORCH_GIT_VERSION} /vision && \
   true

WORKDIR /vision
RUN echo "** BUILDING TORCHVISION *** " && \
    /opt/py313/bin/python setup.py bdist_wheel && \
    /opt/py313/bin/pip install dist/torchvision-*.whl && \
    mkdir -p /vision/dist && \
    true

###########
### Build TorchAudio
###########
ENV TORCHAUDIO_GIT_VERSION="v2.6.0"
RUN echo "** Checkout Torchaudio Version: ${TORCHAUDIO_GIT_VERSION} **" && \
    git clone https://github.com/pytorch/audio.git -b ${TORCHAUDIO_GIT_VERSION} /audio && \
    true

WORKDIR /audio
RUN echo "** BUILDING Torchaudio **" && \
    /opt/py313/bin/python setup.py bdist_wheel && \
    /opt/py313/bin/pip install dist/*.whl && \
    true

######
# End of building pytorch and torchvision WHL-Files
###########

CMD ["/bin/bash","-c"]
